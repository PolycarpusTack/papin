# MCP Architecture

## Interface Architecture

```
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│                 │  │                 │  │                 │
│  GUI (Tauri)    │  │  CLI            │  │  TUI            │
│                 │  │                 │  │                 │
└────────┬────────┘  └────────┬────────┘  └────────┬────────┘
         │                    │                    │
         │                    │                    │
         ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────┐
│                                                         │
│               Common Library (mcp-common)               │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## GUI Architecture 

```
┌─────────────────────────────┐                 ┌────────────────────────┐
│                             │                 │                        │
│ FRONTEND (React)            │                 │ BACKEND (Rust)         │
│                             │                 │                        │
│  ┌─────────────────────┐    │                 │   ┌──────────────┐    │
│  │                     │    │                 │   │              │    │
│  │  Chat Component     │    │                 │   │ Tauri        │    │
│  │                     │    │    Commands     │   │ Commands     │    │
│  └──────────┬──────────┘    ◄─────────────────►   │              │    │
│             │               │                 │   └──────┬───────┘    │
│             │               │                 │          │            │
│  ┌──────────▼──────────┐    │                 │   ┌──────▼───────┐    │
│  │                     │    │                 │   │              │    │
│  │  State Management   │    │                 │   │ Services     │    │
│  │                     │    │                 │   │              │    │
│  └──────────┬──────────┘    │                 │   └──────┬───────┘    │
│             │               │                 │          │            │
│             │               │                 │   ┌──────▼───────┐    │
│  ┌──────────▼──────────┐    │                 │   │              │    │
│  │                     │    │                 │   │ Protocol     │    │
│  │  Event Listeners    │    │    Events       │   │ Handlers     │    │
│  │                     │    ◄─────────────────►   │              │    │
│  └─────────────────────┘    │                 │   └──────┬───────┘    │
│                             │                 │          │            │
└─────────────────────────────┘                 │   ┌──────▼───────┐    │
                                                │   │              │    │
                                                │   │ WebSocket    │    │
                                                │   │ Client       │    │
                                                │   │              │    │
                                                │   └──────┬───────┘    │
                                                │          │            │
                                                └──────────┼────────────┘
                                                           │
                                                           │
                                                ┌──────────▼───────────┐
                                                │                      │
                                                │  MCP Server          │
                                                │  (Anthropic API)     │
                                                │                      │
                                                └──────────────────────┘
```

## CLI Architecture

```
┌─────────────────────────────┐
│                             │
│ CLI COMMANDS                │
│                             │
│  ┌─────────────────────┐    │
│  │                     │    │
│  │  Command Handlers   │    │
│  │                     │    │
│  └──────────┬──────────┘    │
│             │               │
│             │               │
│  ┌──────────▼──────────┐    │
│  │                     │    │
│  │  Display Formatters │    │
│  │                     │    │
│  └──────────┬──────────┘    │
│             │               │
│             │               │
└─────────────┼───────────────┘
              │
              │
┌─────────────▼───────────────┐
│                             │
│ COMMON LIBRARY              │
│                             │
│  ┌─────────────────────┐    │
│  │                     │    │
│  │  Services           │    │
│  │                     │    │
│  └──────────┬──────────┘    │
│             │               │
│             │               │
│  ┌──────────▼──────────┐    │
│  │                     │    │
│  │  Protocol Handlers  │    │
│  │                     │    │
│  └──────────┬──────────┘    │
│             │               │
│             │               │
└─────────────┼───────────────┘
              │
              │
        ┌─────▼─────┐
        │           │
        │ MCP Server│
        │           │
        └───────────┘
```

## TUI Architecture

```
┌─────────────────────────────┐
│                             │
│ TUI COMPONENTS              │
│                             │
│  ┌─────────────────────┐    │
│  │                     │    │
│  │  App Logic          │    │
│  │                     │    │
│  └──────────┬──────────┘    │
│             │               │
│             │               │
│  ┌──────────▼──────────┐    │
│  │                     │    │
│  │  UI Rendering       │    │
│  │                     │    │
│  └──────────┬──────────┘    │
│             │               │
│             │               │
│  ┌──────────▼──────────┐    │
│  │                     │    │
│  │  Event Handling     │    │
│  │                     │    │
│  └──────────┬──────────┘    │
│             │               │
│             │               │
└─────────────┼───────────────┘
              │
              │
┌─────────────▼───────────────┐
│                             │
│ COMMON LIBRARY              │
│                             │
│  ┌─────────────────────┐    │
│  │                     │    │
│  │  Services           │    │
│  │                     │    │
│  └──────────┬──────────┘    │
│             │               │
│             │               │
│  ┌──────────▼──────────┐    │
│  │                     │    │
│  │  Protocol Handlers  │    │
│  │                     │    │
│  └──────────┬──────────┘    │
│             │               │
│             │               │
└─────────────┼───────────────┘
              │
              │
        ┌─────▼─────┐
        │           │
        │ MCP Server│
        │           │
        └───────────┘
```

## Service Layer Architecture

```
┌──────────────────────────────────────────────────────────────────┐
│                                                                  │
│  Application Layer                                               │
│                                                                  │
│  ┌─────────────┐     ┌────────────────┐     ┌────────────────┐   │
│  │             │     │                │     │                │   │
│  │ ChatService │─────► AuthService    │─────► ApiService     │   │
│  │             │     │                │     │                │   │
│  └──────┬──────┘     └────────────────┘     └────────────────┘   │
│         │                                                        │
└─────────┼────────────────────────────────────────────────────────┘
          │
┌─────────▼────────────────────────────────────────────────────────┐
│                                                                  │
│  Protocol Layer                                                  │
│                                                                  │
│  ┌─────────────┐     ┌────────────────┐                          │
│  │             │     │                │                          │
│  │ McpService  │─────► McpClient      │                          │
│  │             │     │                │                          │
│  └──────┬──────┘     └───────┬────────┘                          │
│         │                    │                                   │
└─────────┼────────────────────┼───────────────────────────────────┘
          │                    │
┌─────────▼────────────────────▼───────────────────────────────────┐
│                                                                  │
│  Transport Layer                                                 │
│                                                                  │
│  ┌──────────────────┐     ┌─────────────────┐                    │
│  │                  │     │                 │                    │
│  │ ProtocolHandler  │─────► WebSocketClient │                    │
│  │                  │     │                 │                    │
│  └──────────────────┘     └────────┬────────┘                    │
│                                    │                             │
└─────────────────────────────────────────────────────────────────┘
                                     │
                            ┌────────▼────────┐
                            │                 │
                            │  MCP Server     │
                            │                 │
                            └─────────────────┘
```

## Message Structure

```
┌─────────────────────────────────────────┐
│ MCP Message                             │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ id: "msg_123abc"                    │ │
│ ├─────────────────────────────────────┤ │
│ │ version: "v1"                       │ │
│ ├─────────────────────────────────────┤ │
│ │ type: CompletionRequest             │ │
│ ├─────────────────────────────────────┤ │
│ │ payload:                            │ │
│ │ ┌───────────────────────────────┐   │ │
│ │ │ model: "claude-3-opus-20240229"│   │ │
│ │ ├───────────────────────────────┤   │ │
│ │ │ messages: [...]               │   │ │
│ │ ├───────────────────────────────┤   │ │
│ │ │ max_tokens: 4000              │   │ │
│ │ ├───────────────────────────────┤   │ │
│ │ │ temperature: 0.7              │   │ │
│ │ ├───────────────────────────────┤   │ │
│ │ │ stream: false                 │   │ │
│ │ └───────────────────────────────┘   │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

## WebSocket Connection Flow

```
┌────────┐                            ┌────────────────┐
│ Client │                            │ MCP Server     │
└───┬────┘                            └────────┬───────┘
    │                                          │
    │ WebSocket Connect                        │
    ├─────────────────────────────────────────►│
    │                                          │
    │ WebSocket Connection Established         │
    │◄─────────────────────────────────────────┤
    │                                          │
    │ AuthRequest {api_key: "sk_..."}          │
    ├─────────────────────────────────────────►│
    │                                          │
    │ AuthResponse {success: true}             │
    │◄─────────────────────────────────────────┤
    │                                          │
    │ Ping {}                                  │
    ├─────────────────────────────────────────►│
    │                                          │
    │ Pong {}                                  │
    │◄─────────────────────────────────────────┤
    │                                          │
    │ CompletionRequest {...}                  │
    ├─────────────────────────────────────────►│
    │                                          │
    │ CompletionResponse {...}                 │
    │◄─────────────────────────────────────────┤
    │                                          │
    │ Connection Closed                        │
    ├─────────────────────────────────────────►│
    │                                          │
```

## Streaming Message Flow

```
┌────────┐                            ┌────────────────┐
│ Client │                            │ MCP Server     │
└───┬────┘                            └────────┬───────┘
    │                                          │
    │ CompletionRequest {stream: true}         │
    ├─────────────────────────────────────────►│
    │                                          │
    │ StreamingMessage {chunk: "This"}         │
    │◄─────────────────────────────────────────┤
    │                                          │
    │ StreamingMessage {chunk: " is a"}        │
    │◄─────────────────────────────────────────┤
    │                                          │
    │ StreamingMessage {chunk: " test."}       │
    │◄─────────────────────────────────────────┤
    │                                          │
    │ StreamingEnd {}                          │
    │◄─────────────────────────────────────────┤
    │                                          │
```

## Multi-Interface Architecture Benefits

The multi-interface approach (GUI, CLI, TUI) provides several advantages:

1. **Flexibility**: Users can choose the interface that best fits their workflow and environment
2. **Accessibility**: Terminal-based interfaces work in environments where GUI is not available
3. **Integration**: CLI enables integration with other tools and scripts
4. **Consistency**: Shared library ensures all interfaces provide the same functionality
5. **Code Reuse**: Core logic is implemented once and used across all interfaces
6. **Maintainability**: Changes to the protocol or core logic only need to be made in one place

## Component Communication

```
┌────────────┐  ┌────────────┐  ┌────────────┐
│            │  │            │  │            │
│    GUI     │  │    CLI     │  │    TUI     │
│            │  │            │  │            │
└─────┬──────┘  └─────┬──────┘  └─────┬──────┘
      │               │               │
      ▼               ▼               ▼
┌────────────────────────────────────────────┐
│                                            │
│           Common Service Layer             │
│                                            │
└─────────────────┬──────────────────────────┘
                  │
                  ▼
┌────────────────────────────────────────────┐
│                                            │
│               MCP Protocol                 │
│                                            │
└─────────────────┬──────────────────────────┘
                  │
                  ▼
┌────────────────────────────────────────────┐
│                                            │
│             Provider Selection             │
│                                            │
└──┬─────────────────────────────────────┬───┘
   │                                     │
   ▼                                     ▼
┌─────────────┐                  ┌─────────────┐
│             │                  │             │
│ Claude API  │                  │ Local Model │
│             │                  │             │
└─────────────┘                  └─────────────┘
```
