# MCP Architecture

```
┌─────────────────────────────┐                 ┌────────────────────────┐
│                             │                 │                        │
│ FRONTEND (React)            │                 │ BACKEND (Rust)         │
│                             │                 │                        │
│  ┌─────────────────────┐    │                 │   ┌──────────────┐    │
│  │                     │    │                 │   │              │    │
│  │  Chat Component     │    │                 │   │ Tauri        │    │
│  │                     │    │    Commands     │   │ Commands     │    │
│  └──────────┬──────────┘    ◄─────────────────►   │              │    │
│             │               │                 │   └──────┬───────┘    │
│             │               │                 │          │            │
│  ┌──────────▼──────────┐    │                 │   ┌──────▼───────┐    │
│  │                     │    │                 │   │              │    │
│  │  State Management   │    │                 │   │ Services     │    │
│  │                     │    │                 │   │              │    │
│  └──────────┬──────────┘    │                 │   └──────┬───────┘    │
│             │               │                 │          │            │
│             │               │                 │   ┌──────▼───────┐    │
│  ┌──────────▼──────────┐    │                 │   │              │    │
│  │                     │    │                 │   │ Protocol     │    │
│  │  Event Listeners    │    │    Events       │   │ Handlers     │    │
│  │                     │    ◄─────────────────►   │              │    │
│  └─────────────────────┘    │                 │   └──────┬───────┘    │
│                             │                 │          │            │
└─────────────────────────────┘                 │   ┌──────▼───────┐    │
                                                │   │              │    │
                                                │   │ WebSocket    │    │
                                                │   │ Client       │    │
                                                │   │              │    │
                                                │   └──────┬───────┘    │
                                                │          │            │
                                                └──────────┼────────────┘
                                                           │
                                                           │
                                                ┌──────────▼───────────┐
                                                │                      │
                                                │  MCP Server          │
                                                │  (Anthropic API)     │
                                                │                      │
                                                └──────────────────────┘
```

## Message Flow

```
┌─────────┐  1. User Input   ┌────────────┐  2. Command    ┌─────────────┐
│         │ ─────────────────►            │ ───────────────►             │
│  React  │                  │   State    │                │    Tauri    │
│   UI    │                  │ Management │                │  Commands   │
│         │                  │            │                │             │
└─────────┘                  └────────────┘                └──────┬──────┘
    ▲                               ▲                              │
    │                               │                              │
    │ 8. Update UI                  │ 7. Event                     │ 3. Service Call
    │                               │    Notification              │
    │                               │                              ▼
┌───┴─────┐                  ┌──────┴─────┐                 ┌─────────────┐
│         │  6. Event        │            │                 │             │
│  Event  │ ◄────────────────┤   Event    │                 │  Services   │
│ Handlers│                  │   System   │                 │             │
│         │                  │            │                 └──────┬──────┘
└─────────┘                  └────────────┘                        │
                                    ▲                              │
                                    │ 5. Emit Event                │ 4. Protocol Call
                                    │                              │
                                    │                              ▼
                                ┌───┴──────────┐            ┌─────────────┐
                                │              │            │             │
                                │  WebSocket   │ ◄──────────►     MCP     │
                                │   Client     │ WebSocket  │    Server   │
                                │              │            │             │
                                └──────────────┘            └─────────────┘
```

## Protocol Layers

```
┌──────────────────────────────────────────────────────────────────┐
│                                                                  │
│  Application Layer                                               │
│                                                                  │
│  ┌─────────────┐     ┌────────────────┐     ┌────────────────┐   │
│  │             │     │                │     │                │   │
│  │ ChatService │─────► AuthService    │─────► ApiService     │   │
│  │             │     │                │     │                │   │
│  └──────┬──────┘     └────────────────┘     └────────────────┘   │
│         │                                                        │
└─────────┼────────────────────────────────────────────────────────┘
          │
┌─────────▼────────────────────────────────────────────────────────┐
│                                                                  │
│  Protocol Layer                                                  │
│                                                                  │
│  ┌─────────────┐     ┌────────────────┐                          │
│  │             │     │                │                          │
│  │ McpService  │─────► McpClient      │                          │
│  │             │     │                │                          │
│  └──────┬──────┘     └───────┬────────┘                          │
│         │                    │                                   │
└─────────┼────────────────────┼───────────────────────────────────┘
          │                    │
┌─────────▼────────────────────▼───────────────────────────────────┐
│                                                                  │
│  Transport Layer                                                 │
│                                                                  │
│  ┌──────────────────┐     ┌─────────────────┐                    │
│  │                  │     │                 │                    │
│  │ ProtocolHandler  │─────► WebSocketClient │                    │
│  │                  │     │                 │                    │
│  └──────────────────┘     └────────┬────────┘                    │
│                                    │                             │
└─────────────────────────────────────────────────────────────────┘
                                     │
                            ┌────────▼────────┐
                            │                 │
                            │  MCP Server     │
                            │                 │
                            └─────────────────┘
```

## Message Structure

```
┌─────────────────────────────────────────┐
│ MCP Message                             │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ id: "msg_123abc"                    │ │
│ ├─────────────────────────────────────┤ │
│ │ version: "v1"                       │ │
│ ├─────────────────────────────────────┤ │
│ │ type: CompletionRequest             │ │
│ ├─────────────────────────────────────┤ │
│ │ payload:                            │ │
│ │ ┌───────────────────────────────┐   │ │
│ │ │ model: "claude-3-opus-20240229"│   │ │
│ │ ├───────────────────────────────┤   │ │
│ │ │ messages: [...]               │   │ │
│ │ ├───────────────────────────────┤   │ │
│ │ │ max_tokens: 4000              │   │ │
│ │ ├───────────────────────────────┤   │ │
│ │ │ temperature: 0.7              │   │ │
│ │ ├───────────────────────────────┤   │ │
│ │ │ stream: false                 │   │ │
│ │ └───────────────────────────────┘   │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

## WebSocket Connection Flow

```
┌────────┐                            ┌────────────────┐
│ Client │                            │ MCP Server     │
└───┬────┘                            └────────┬───────┘
    │                                          │
    │ WebSocket Connect                        │
    ├─────────────────────────────────────────►│
    │                                          │
    │ WebSocket Connection Established         │
    │◄─────────────────────────────────────────┤
    │                                          │
    │ AuthRequest {api_key: "sk_..."}          │
    ├─────────────────────────────────────────►│
    │                                          │
    │ AuthResponse {success: true}             │
    │◄─────────────────────────────────────────┤
    │                                          │
    │ Ping {}                                  │
    ├─────────────────────────────────────────►│
    │                                          │
    │ Pong {}                                  │
    │◄─────────────────────────────────────────┤
    │                                          │
    │ CompletionRequest {...}                  │
    ├─────────────────────────────────────────►│
    │                                          │
    │ CompletionResponse {...}                 │
    │◄─────────────────────────────────────────┤
    │                                          │
    │ Connection Closed                        │
    ├─────────────────────────────────────────►│
    │                                          │
```

## Streaming Message Flow

```
┌────────┐                            ┌────────────────┐
│ Client │                            │ MCP Server     │
└───┬────┘                            └────────┬───────┘
    │                                          │
    │ CompletionRequest {stream: true}         │
    ├─────────────────────────────────────────►│
    │                                          │
    │ StreamingMessage {chunk: "This"}         │
    │◄─────────────────────────────────────────┤
    │                                          │
    │ StreamingMessage {chunk: " is a"}        │
    │◄─────────────────────────────────────────┤
    │                                          │
    │ StreamingMessage {chunk: " test."}       │
    │◄─────────────────────────────────────────┤
    │                                          │
    │ StreamingEnd {}                          │
    │◄─────────────────────────────────────────┤
    │                                          │
```
